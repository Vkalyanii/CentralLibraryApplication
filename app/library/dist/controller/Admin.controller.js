sap.ui.define(["./BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/Token","sap/m/MessageToast"],function(e,t,o,i,n,s,a){"use strict";return e.extend("com.app.library.controller.Admin",{onInit:function(){this.oQuantity=null;this.oAq=null;const e=this.getOwnerComponent().getRouter();e.attachRoutePatternMatched(this.onUserDetailsLoad,this);const t=new i({ISBN:"",Title:"",Author:"",Genre:"",No_of_books:0,Description:"",Avl_Quantity:0});this.getView().setModel(t,"localModel");this.getOwnerComponent().getRouter().attachRoutePatternMatched(this.onBookListLoad,this);const o=this.getView();const n=o.byId("idtitleFilterValue");const a=o.byId("idAuthorFilterValue");const r=o.byId("idGenreFilterValue");const l=o.byId("idISBNFilterValue");let d=function(e){if(true){var t=e.text;return new s({key:t,text:t})}};n.addValidator(d);a.addValidator(d);r.addValidator(d);l.addValidator(d)},setHeaderContext:function(){var e=this.getView();e.byId("Bookstitle").setBindingContext(e.byId("_IDGenTable1").getBinding("items").getHeaderContext())},onBookListLoad:function(){this.getView().byId("idBookTable").getBinding("items").refresh()},onUserDetailsLoad:function(e){const{id:t}=e.getParameter("arguments");this.ID=t;const o=this.getView().byId("idBooks");o.bindElement(`/User(${t})`)},onGoPress:function(){const e=this.getView(),i=e.byId("idtitleFilterValue"),n=i.getTokens(),s=e.byId("idAuthorFilterValue"),a=s.getTokens(),r=e.byId("idISBNFilterValue"),l=r.getTokens(),d=e.byId("idGenreFilterValue"),g=d.getTokens(),c=e.byId("idBookTable"),u=[];n.filter(e=>{e?u.push(new t("Title",o.EQ,e.getKey())):""});a.filter(e=>{e?u.push(new t("Author",o.EQ,e.getKey())):""});l.filter(e=>{e?u.push(new t("ISBN",o.EQ,e.getKey())):""});g.filter(e=>{e?u.push(new t("Genre",o.EQ,e.getKey())):""});c.getBinding("items").filter(u)},onClearFilterPress:function(){const e=this.getView(),t=e.byId("idtitleFilterValue"),o=t.removeAllTokens(),i=e.byId("idAuthorFilterValue"),n=i.removeAllTokens(),s=e.byId("idGenreFilterValue"),a=s.removeAllTokens(),r=e.byId("idISBNFilterValue"),l=r.removeAllTokens()},onCreateBtnPress:async function(){if(!this.oCreateEmployeeDialog){this.oCreateEmployeeDialog=await this.loadFragment("CreateBookDialog")}this.oCreateEmployeeDialog.open()},onCloseDialog:function(){if(this.oCreateEmployeeDialog.isOpen()){this.oCreateEmployeeDialog.close()}},oncancelbtnbook:function(){if(this.oCreateEmployeeDialog.isOpen()){this.oCreateEmployeeDialog.close()}},onCreateBook:async function(){debugger;var e=this.getView().getModel("localModel").getProperty("/"),t=this.getView().getModel("modelv2");e.Avl_Quantity=e.No_of_books;this.getView().getModel("localModel").setData(e);if(!(e.ISBN&&e.Author&&e.Genre&&e.Description&&e.No_of_books&&e.Title)){a.show("Enter all details");return}console.log(typeof e.No_of_books);try{const o=await this.checkTitle(t,e.Title,e.ISBN);if(o){a.show("Book already exsist");return}const i=await this.checkISBN(t,e.ISBN);if(i){a.show("Book with ISBN already exsist");return}await this.createData(t,e,"/Book");this.getView().byId("idBookTable").getBinding("items").refresh();this.oCreateEmployeeDialog.close()}catch(e){this.oCreateEmployeeDialog.close();n.error("Some technical Issue")}location.reload()},onDeleteBtnPress:async function(){var e=this.byId("idBookTable").getSelectedItems();n.confirm("Are you sure? you want to delete this book",{onClose:function(t){if(t===n.Action.OK){if(e.length>0){var o=[];e.forEach(function(e){const{ISBN:t,No_of_books:i,Avl_Quantity:n}=e.getBindingContext().getObject();if(i===n){o.push(t);e.getBindingContext().delete("$auto")}else{a.show("Book is Already in Active Loans");return}});Promise.all(o.map(function(e){return new Promise(function(t,o){t(e+" Successfully Deleted")})})).then(function(e){e.forEach(function(e){a.show(e)})}).catch(function(e){a.show("Deletion Error: "+e)});this.getView().byId("idBookTable").removeSelections(true);this.getView().byId("idBookTable").getBinding("items").refresh()}else{a.show("Please Select Rows to Delete")}}}})},onUpdateBtnPress:async function(){var e=this.byId("idBookTable").getSelectedItems();if(e.length===0){a.show("Please Select atleast one Book to Edit");return}if(e.length>1){a.show("Please Select only one Book to Edit");return}if(e){var t=e[0].getBindingContext().getProperty("ID");var o=e[0].getBindingContext().getProperty("ISBN");var i=e[0].getBindingContext().getProperty("Author");var n=e[0].getBindingContext().getProperty("Title");var s=e[0].getBindingContext().getProperty("Genre");this.oQuantity=e[0].getBindingContext().getProperty("No_of_books");var r=e[0].getBindingContext().getProperty("Description");this.oAq=e[0].getBindingContext().getProperty("Avl_Quantity");var l=new sap.ui.model.json.JSONModel({ID:t,ISBN:o,Author:i,Title:n,Genre:s,No_of_books:this.oQuantity,Description:r,Avl_Quantity:this.oAq});this.getView().setModel(l,"newBookModel");if(!this.oEditBooksDialog){this.oEditBooksDialog=await this.loadFragment("EditBook")}this.oEditBooksDialog.open();var d=this.getView().getModel("newBookModel").getData();console.log(d)}},onSave:function(){var e=parseInt(this.getView().byId("idNo_of_booksVal").getValue());var t=parseInt(this.getView().byId("idAvailabilityVal").getValue());if(this.oQuantity<e){e=e-this.oQuantity;t=t+e}else if(this.oQuantity>e){e=this.oQuantity-e;t=t-e}else{t=t}console.log(e);var o=this.getView().getModel("newBookModel").getData();o.Avl_Quantity=t;this.getView().getModel("newBookModel").setData(o);var i=this.getOwnerComponent().getModel("modelv2");console.log(i.getMetadata().getName());try{i.update("/Book("+o.ID+")",o,{success:function(){this.getView().byId("idBookTable").getBinding("items").refresh();this.oEditBooksDialog.close()}.bind(this),error:function(e){this.oEditBooksDialog.close();sap.m.MessageBox.error("Failed to update book: "+e.message)}.bind(this)})}catch(e){this.oEditBooksDialog.close();sap.m.MessageBox.error("Some technical Issue")}var i=new sap.ui.model.odata.v2.ODataModel({serviceUrl:"https://port4004-workspaces-ws-dv77z.us10.trial.applicationstudio.cloud.sap/v2/BookSRV",defaultBindingMode:sap.ui.model.BindingMode.TwoWay,messageParser:sap.ui.model.odata.ODataMessageParser})},onClose:function(){if(this.oEditBooksDialog.isOpen()){this.oEditBooksDialog.close()}},onActiveLoans:function(){var e=this.getOwnerComponent().getRouter();e.navTo("RouteActiveLoans")},onIssueBooks:function(){var e=this.getOwnerComponent().getRouter();e.navTo("RouteIssueBooks")},onClickUsers:function(){var e=this.getOwnerComponent().getRouter();e.navTo("RouteAllUsers")},checkTitle:async function(e,i,n){return new Promise((n,s)=>{e.read("/Book",{filters:[new t("Title",o.EQ,i)],success:function(e){n(e.results.length>0)},error:function(){s("An error occurred while checking username existence.")}})})},checkISBN:async function(e,i){return new Promise((n,s)=>{e.read("/Book",{filters:[new t("ISBN",o.EQ,i)],success:function(e){n(e.results.length>0)},error:function(){s("An error occurred while checking username existence.")}})})},OnSignoutClick:function(){var e=this.getOwnerComponent().getRouter();e.navTo("RouteHome",{},true)},onAdminNotificationPress:async function(){if(!this.oLoginDialog){this.oLoginDialog=await this.loadFragment("NewUserSignUp")}this.oLoginDialog.open()},onCloseDialog1:function(){if(this.oLoginDialog.isOpen()){this.oLoginDialog.close()}}})});