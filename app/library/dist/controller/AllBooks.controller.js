sap.ui.define(["./BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/Token","sap/m/MessageToast"],function(e,t,o,s,n,i,r){"use strict";return e.extend("com.app.library.controller.AllBooks",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.attachRoutePatternMatched(this.onUserDetailsLoad,this);const t=this.getView();const o=t.byId("idtitleFilterValue");const s=t.byId("idAuthorFilterValue");const n=t.byId("idGenreFilterValue");const r=t.byId("idISBNFilterValue");let l=function(e){if(true){var t=e.text;return new i({key:t,text:t})}};o.addValidator(l);s.addValidator(l);n.addValidator(l);r.addValidator(l)},onUserDetailsLoad:function(e){const{id:t}=e.getParameter("arguments");this.ID=t;const o=e.getParameter("name");const s=this.getView().byId("idAllBooks");s.bindElement(`/User(${t})`)},onGoPress:function(){const e=this.getView(),s=e.byId("idtitleFilterValue"),n=s.getTokens(),i=e.byId("idAuthorFilterValue"),r=i.getTokens(),l=e.byId("idISBNFilterValue"),a=l.getTokens(),d=e.byId("idGenreFilterValue"),c=d.getTokens(),u=e.byId("idAllBooksTable"),g=[];n.filter(e=>{e?g.push(new t("Title",o.EQ,e.getKey())):""});r.filter(e=>{e?g.push(new t("Author",o.EQ,e.getKey())):""});a.filter(e=>{e?g.push(new t("ISBN",o.EQ,e.getKey())):""});c.filter(e=>{e?g.push(new t("Genre",o.EQ,e.getKey())):""});u.getBinding("items").filter(g)},onClearFilterPress:function(){const e=this.getView(),t=e.byId("idtitleFilterValue"),o=t.removeAllTokens(),s=e.byId("idAuthorFilterValue"),n=s.removeAllTokens(),i=e.byId("idGenreFilterValue"),r=i.removeAllTokens(),l=e.byId("idISBNFilterValue"),a=l.removeAllTokens()},onReserve:async function(e){console.log(typeof this.getView().byId("idte").getText());var t=e.getSource().getParent();var o=t.getBindingContext();console.log(e.getSource().getParent().getBindingContext().getObject());console.log(o);var s=this.ID;if(this.byId("idAllBooksTable").getSelectedItems().length>1){r.show("Please Select only one Book");return}var n=this.byId("idAllBooksTable").getSelectedItem().getBindingContext().getObject();console.log(n.Avl_Quantity);if(n.Avl_Quantity===0){r.show("Book not available");return}var i=n.Avl_Quantity-1;console.log(i);const l=await this.bookInactiveLoans(n.ID,s);if(l){r.show("You had a ActiveLoan for selected book.");return}const a=await this.checkIfBookIsReservedByUser(n.ID,s);if(a){r.show("This book is already reserved .");return}const d=new sap.ui.model.json.JSONModel({user_ID_ID:s,book_ID:n.ID,reservation_date:new Date,book:{Avl_Quantity:i}});this.getView().setModel(d,"userModel");const c=this.getView().getModel("userModel").getProperty("/"),u=this.getView().getModel("modelv2");try{await this.createData(u,c,"/Reservation");sap.m.MessageBox.success("Book is Reserved")}catch(e){sap.m.MessageBox.error("Some technical Issue")}},checkIfBookIsReservedByUser:function(e,s){return new Promise((n,i)=>{const r=this.getView().getModel("modelv2");const l=[new t("book_ID",o.EQ,e),new t("user_ID_ID",o.EQ,s)];r.read("/Reservation",{filters:l,success:function(e){n(e.results.length>0)},error:function(e){i(e)}})})},bookInactiveLoans:function(e,s){debugger;return new Promise((n,i)=>{const r=this.getView().getModel("modelv2");const l=[new t("book_ID",o.EQ,e),new t("user_ID_ID",o.EQ,s)];r.read("/BookLoan",{filters:l,success:function(e){console.log("ActiveLoans data:",e);const t=e.results.some(e=>!e.returndate);console.log("Active loans found:",t);n(t)},error:function(e){console.error("Error reading Bookloans:",e);i(e)}})})}})});